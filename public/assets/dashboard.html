<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DORA Metrics Dashboard</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root{--bg:#f5f8fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;--radius:12px}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1200px;margin:28px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px}
    h1{margin:0;font-size:26px}
    .meta-line{color:var(--muted);margin-top:6px;font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .input,button,select{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;background:white}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 8px 18px rgba(12,15,20,0.04)}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .big-card{grid-column:1 / span 3}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .big-card{grid-column:auto} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>DORA Metrics Dashboard</h1>
        <div id="meta-line" class="meta-line">Window: -- · Successes: -- · Failures: -- · Commits: --</div>
      </div>

      <div class="controls">
        <input id="daterange" class="input" placeholder="Select range (days)"/>
        <select id="tz" class="input">
          <option value="local">Local timezone</option>
          <option value="UTC">UTC</option>
        </select>
        <button id="refresh" class="input">Refresh</button>
        <button id="exportCsv" class="input">Export CSV</button>
      </div>
    </header>

    <div style="margin-top:18px;display:flex;gap:12px;align-items:center">
      <div class="card" style="padding:12px">Deployments: <strong id="total-deploy">--</strong></div>
      <div class="card" style="padding:12px">Avg lead: <strong id="avg-lead">--</strong></div>
      <div class="card" style="padding:12px">Median lead: <strong id="med-lead">--</strong></div>
      <div class="card" style="padding:12px">95% lead: <strong id="p95-lead">--</strong></div>
      <div class="card" style="padding:12px">Contributors: <strong id="contributors">--</strong></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Deployment Frequency</h3>
        <canvas id="chart-frequency"></canvas>
      </div>

      <div class="card">
        <h3>Change Failure Rate</h3>
        <canvas id="chart-cfr"></canvas>
      </div>

      <div class="card">
        <h3>Lead Time (hours)</h3>
        <canvas id="chart-leadtime"></canvas>
      </div>

      <div class="card big-card">
        <h3>Recent Deployments</h3>
        <div style="overflow:auto;max-height:280px">
          <table id="runs-table" aria-live="polite">
            <thead><tr><th>#</th><th>Workflow</th><th>Conclusion</th><th>Run</th><th>When</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px">Click run column to open GitHub actions run in a new tab.</div>
      </div>
    </div>
  </div>

  <script>
    function toHours(ms) { return ms == null ? null : +(ms / 3600000).toFixed(2); }
    function formatTime(iso, tz) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (tz === 'UTC') return d.toISOString().replace('T', ' ').replace('Z',' UTC');
      return d.toLocaleString();
    }

    let charts = {};
    function destroyChart(key) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }

    function drawChartFrequency(labels, data) {
      destroyChart('freq');
      const ctx = document.getElementById('chart-frequency').getContext('2d');
      charts.freq = new Chart(ctx, { type: 'bar',
        data: { labels, datasets:[{label:'Deploys/day', data, backgroundColor:'#3b82f6'}] },
        options: { plugins:{ tooltip:{callbacks:{ label: c => `${c.parsed.y} deploy(s)` } } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function drawChartCFR(labels, data) {
      destroyChart('cfr');
      const ctx = document.getElementById('chart-cfr').getContext('2d');
      charts.cfr = new Chart(ctx, { type: 'line',
        data:{ labels, datasets:[{label:'CFR', data, borderColor:'#2563eb', fill:false}] },
        options:{ plugins:{ tooltip:{ callbacks:{ label: c => c.parsed.y == null ? 'CFR: N/A' : `CFR: ${(c.parsed.y*100).toFixed(1)}%` } } }, scales:{ y:{ beginAtZero:true, max:1, ticks:{ callback: v => `${Math.round(v*100)}%` } } } }
      });
    }

    function drawChartLead(labels, data) {
      destroyChart('lead');
      const ctx = document.getElementById('chart-leadtime').getContext('2d');
      charts.lead = new Chart(ctx, { type:'line',
        data:{ labels, datasets:[{label:'Lead time (h)', data, borderColor:'#1d4ed8', fill:false}] },
        options:{ plugins:{ tooltip:{ callbacks:{ label: c => c.parsed.y == null ? 'N/A' : `${c.parsed.y} hr` } } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    async function fetchMetrics(days) { const q = days ? `?days=${days}` : ''; const r = await fetch('/api/metrics/github' + q); return r.json(); }
    async function fetchSummary(days) { const q = days ? `?days=${days}` : ''; const r = await fetch('/api/summary' + q); return r.json(); }
    async function fetchRuns(per_page = 50) { const r = await fetch(`/api/runs?per_page=${per_page}`); return r.json(); }

    function renderRunsTable(runs, tz) {
      const tbody = document.querySelector('#runs-table tbody');
      tbody.innerHTML = '';
      runs.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.run_number}</td>
          <td>${r.name || 'workflow'}</td>
          <td>${r.conclusion}</td>
          <td><a href="${r.html_url}" target="_blank" rel="noopener">Open</a></td>
          <td>${formatTime(r.updated_at, tz)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function exportCsv(daily) {
      const rows = [['date','deployment_frequency','change_failure_rate','lead_time_hours','mttr_hours']];
      Object.keys(daily).sort().forEach(d => {
        const v = daily[d];
        rows.push([d, v.deployment_frequency ?? 0, v.change_failure_rate ?? '', v.lead_time_ms_mean != null ? (v.lead_time_ms_mean/3600000).toFixed(3) : '', v.mttr_ms_mean != null ? (v.mttr_ms_mean/3600000).toFixed(3) : '']);
      });
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `dora_metrics_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function loadDashboard(selectedDays = null) {
      try {
        const days = selectedDays || 60;
        const [metrics, summary, runsResp] = await Promise.all([fetchMetrics(days), fetchSummary(days), fetchRuns(50)]);
        const daily = metrics.daily || {};
        const meta = metrics.meta || {};
        const s = summary || {};

        document.getElementById('meta-line').textContent = `Window: ${meta.window_days || s.window_days || days} days · Successes: ${meta.successes ?? s.successes ?? '--'} · Failures: ${meta.failures ?? s.failures ?? '--'} · Commits: ${meta.commits ?? '--'}`;

        document.getElementById('total-deploy').textContent = s.total_deployments ?? (meta.successes + meta.failures) ?? '--';
        document.getElementById('avg-lead').textContent = s.median_lead_hours !== undefined ? (s.median_lead_hours !== null ? `${s.median_lead_hours} hr` : 'N/A') : (meta.avg_lead_time_hours ? `${meta.avg_lead_time_hours} hr` : 'N/A');
        document.getElementById('med-lead').textContent = s.median_lead_hours !== null ? `${s.median_lead_hours} hr` : 'N/A';
        document.getElementById('p95-lead').textContent = s.p95_lead_hours !== null ? `${s.p95_lead_hours} hr` : 'N/A';
        document.getElementById('contributors').textContent = s.contributors_count ?? '--';

        const daysKeys = Object.keys(daily).sort();
        const freq = daysKeys.map(d => daily[d].deployment_frequency ?? 0);
        const cfr = daysKeys.map(d => daily[d].change_failure_rate == null ? null : +daily[d].change_failure_rate.toFixed(2));
        const lead = daysKeys.map(d => daily[d].lead_time_ms_mean != null ? +(daily[d].lead_time_ms_mean / 3600000).toFixed(3) : null);

        drawChartFrequency(daysKeys, freq);
        drawChartCFR(daysKeys, cfr);
        drawChartLead(daysKeys, lead);

        renderRunsTable(runsResp.runs || [], document.getElementById('tz').value);
        document.getElementById('exportCsv').onclick = () => exportCsv(daily);

      } catch (err) {
        console.error('Dashboard load error', err);
        alert('Failed to load dashboard: ' + (err.message || err));
      }
    }

    // UI wiring
    flatpickr('#daterange', { mode:'single', enableTime:false, defaultDate:null });
    document.getElementById('daterange').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const v = e.target.value.trim();
        const n = Number(v);
        if (!isNaN(n) && n > 0) { loadDashboard(n); } else {
          const d = new Date(v);
          if (!isNaN(d)) {
            const diff = Math.ceil((Date.now() - d.getTime()) / (1000*60*60*24));
            loadDashboard(diff);
          } else { alert('Enter a valid number of days or a valid date.'); }
        }
      }
    });

    document.getElementById('refresh').addEventListener('click', () => {
      const v = document.getElementById('daterange').value.trim();
      const n = Number(v);
      loadDashboard((!isNaN(n) && n > 0) ? n : null);
    });

    document.getElementById('tz').addEventListener('change', () => loadDashboard());

    loadDashboard();
  </script>
</body>
</html>