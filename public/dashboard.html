<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DORA Metrics Dashboard</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root{--bg:#f5f8fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;--radius:12px}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:#0f172a}
    /* make the dashboard full-width rather than centered; remove horizontal padding for true edge-to-edge */
    .container{width:100%;max-width:unset;margin:0;padding:12px 0;box-sizing:border-box}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px}
    h1{margin:0;font-size:26px}
    .meta-line{color:var(--muted);margin-top:6px;font-size:14px}
    .controls{display:flex;gap:12px;align-items:center}
    .input,button,select{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;background:white}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 8px 18px rgba(12,15,20,0.04)}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .big-card{grid-column:1 / span 3}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .big-card{grid-column:auto} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>DORA Metrics Dashboard</h1>
        <div id="meta-line" class="meta-line">Window: -- · Successes: -- · Failures: -- · Commits: --</div>
      </div>

      <div class="controls">
        <input id="daterange" class="input" placeholder="Select range (days)"/>
        <select id="tz" class="input">
          <option value="local">Local timezone</option>
          <option value="UTC">UTC</option>
        </select>
        <button id="refresh" class="input">Refresh</button>
        <button id="exportCsv" class="input">Export CSV</button>
      </div>
    </header>

    <div id="banner" class="card" style="margin-top:14px; padding:12px; display:none" role="status" aria-live="polite"></div>

    <div style="margin-top:18px;display:flex;gap:12px;align-items:center">
      <div class="card" style="padding:12px">Deployments: <strong id="total-deploy">--</strong></div>
      <div class="card" style="padding:12px">Avg lead: <strong id="avg-lead">--</strong></div>
      <div class="card" style="padding:12px">Median lead: <strong id="med-lead">--</strong></div>
      <div class="card" style="padding:12px">95% lead: <strong id="p95-lead">--</strong></div>
      <div class="card" style="padding:12px">Contributors: <strong id="contributors">--</strong></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Deployment Frequency</h3>
        <canvas id="chart-frequency"></canvas>
      </div>

      <div class="card">
        <h3>Change Failure Rate</h3>
        <canvas id="chart-cfr"></canvas>
      </div>

      <div class="card">
        <h3>Lead Time (hours)</h3>
        <canvas id="chart-leadtime"></canvas>
      </div>

      <div class="card big-card">
        <h3>Recent Deployments</h3>
        <div style="overflow:auto;max-height:280px">
          <table id="runs-table" aria-live="polite">
            <thead><tr><th>#</th><th>Workflow</th><th>Conclusion</th><th>Run</th><th>When</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px">Click run column to open GitHub actions run in a new tab.</div>
      </div>
    </div>
  </div>

  <script>
    const banner = document.getElementById('banner');
    function showBanner(message) {
      banner.textContent = message;
      banner.style.display = 'block';
    }

    // API base resolution:
    // - Default: same origin (works when served from the Node app)
    // - If opened via file://, default to local server http://localhost:3000
    // - Optional override: ?apiBase=http://localhost:3000
    const params = new URLSearchParams(window.location.search);
    const apiBaseParam = (params.get('apiBase') || params.get('api') || '').trim();
    const API_BASE = (apiBaseParam
      ? apiBaseParam.replace(/\/+$/, '')
      : (window.location.protocol === 'file:' ? 'http://localhost:3000' : '')
    );

    if (window.location.protocol === 'file:') {
      showBanner('This dashboard is opened as a local file. Start the server with: npm start, then open http://localhost:3000/dashboard.html (recommended).');
    }

    function toHours(ms) { return ms == null ? null : +(ms / 3600000).toFixed(2); }
    function formatTime(iso, tz) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (tz === 'UTC') return d.toISOString().replace('T', ' ').replace('Z',' UTC');
      return d.toLocaleString();
    }

    let charts = {};
    function destroyChart(key) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }

    function drawChartFrequency(labels, data) {
      destroyChart('freq');
      const ctx = document.getElementById('chart-frequency').getContext('2d');
      charts.freq = new Chart(ctx, { type: 'bar',
        data: { labels, datasets:[{label:'Deploys/day', data, backgroundColor:'#3b82f6'}] },
        options: { plugins:{ tooltip:{callbacks:{ label: c => `${c.parsed.y} deploy(s)` } } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function drawChartCFR(labels, data) {
      destroyChart('cfr');
      const ctx = document.getElementById('chart-cfr').getContext('2d');
      charts.cfr = new Chart(ctx, { type: 'line',
        data:{ labels, datasets:[{label:'CFR', data, borderColor:'#2563eb', fill:false}] },
        options:{ plugins:{ tooltip:{ callbacks:{ label: c => c.parsed.y == null ? 'CFR: N/A' : `CFR: ${(c.parsed.y*100).toFixed(1)}%` } } }, scales:{ y:{ beginAtZero:true, max:1, ticks:{ callback: v => `${Math.round(v*100)}%` } } } }
      });
    }

    function drawChartLead(labels, data) {
      destroyChart('lead');
      const ctx = document.getElementById('chart-leadtime').getContext('2d');
      charts.lead = new Chart(ctx, { type:'line',
        data:{ labels, datasets:[{label:'Lead time (h)', data, borderColor:'#1d4ed8', fill:false}] },
        options:{ plugins:{ tooltip:{ callbacks:{ label: c => c.parsed.y == null ? 'N/A' : `${c.parsed.y} hr` } } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    async function fetchJson(url) {
      const r = await fetch(url);
      if (!r.ok) {
        const text = await r.text();
        throw new Error(`HTTP ${r.status}: ${text || r.statusText}`);
      }
      return r.json();
    }

    async function fetchMetrics(daysOrRange) {
      let q = '';
      if (daysOrRange && typeof daysOrRange === 'object' && daysOrRange.since) {
        const since = encodeURIComponent(daysOrRange.since);
        const until = daysOrRange.until ? `&until=${encodeURIComponent(daysOrRange.until)}` : '';
        q = `?since=${since}${until}`;
      } else if (daysOrRange) {
        q = `?days=${daysOrRange}`;
      }
      return fetchJson(`${API_BASE}/api/metrics/github${q}`);
    }
    async function fetchSummary(daysOrRange) {
      let q = '';
      if (daysOrRange && typeof daysOrRange === 'object' && daysOrRange.since) {
        const since = encodeURIComponent(daysOrRange.since);
        const until = daysOrRange.until ? `&until=${encodeURIComponent(daysOrRange.until)}` : '';
        q = `?since=${since}${until}`;
      } else if (daysOrRange) {
        q = `?days=${daysOrRange}`;
      }
      return fetchJson(`${API_BASE}/api/summary${q}`);
    }
    async function fetchRuns(per_page = 50, daysOrRange) {
      let q = `?per_page=${per_page}`;
      if (daysOrRange && typeof daysOrRange === 'object' && daysOrRange.since) {
        q += `&since=${encodeURIComponent(daysOrRange.since)}`;
        if (daysOrRange.until) q += `&until=${encodeURIComponent(daysOrRange.until)}`;
      }
      return fetchJson(`${API_BASE}/api/runs${q}`);
    }

    function renderRunsTable(runs, tz) {
      const tbody = document.querySelector('#runs-table tbody');
      tbody.innerHTML = '';
      runs.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.run_number}</td>
          <td>${r.name || 'workflow'}</td>
          <td>${r.conclusion}</td>
          <td><a href="${r.html_url}" target="_blank" rel="noopener">Open</a></td>
          <td>${formatTime(r.updated_at, tz)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function exportCsv(daily) {
      const rows = [['date','deployment_frequency','change_failure_rate','lead_time_hours','mttr_hours']];
      Object.keys(daily).sort().forEach(d => {
        const v = daily[d];
        rows.push([d, v.deployment_frequency ?? 0, v.change_failure_rate ?? '', v.lead_time_ms_mean != null ? (v.lead_time_ms_mean/3600000).toFixed(3) : '', v.mttr_ms_mean != null ? (v.mttr_ms_mean/3600000).toFixed(3) : '']);
      });
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `dora_metrics_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    let currentRange = null; // either a number (days) or { since, until }

    async function loadDashboard(selected = null) {
      try {
        const param = selected ?? currentRange ?? 365;
        currentRange = param;
        const [metrics, summary, runsResp] = await Promise.all([fetchMetrics(param), fetchSummary(param), fetchRuns(50, param)]);
        const daily = metrics.daily || {};
        const meta = metrics.meta || {};
        const s = summary || {};

        if (metrics.warning) {
          showBanner(metrics.warning + ' (Set GITHUB_TOKEN in your .env and restart the server)');
        }

        // Show the window either as days or a specific since/until range
        if (param && typeof param === 'object' && param.since) {
          const startText = new Date(param.since).toLocaleDateString();
          const endText = param.until ? new Date(param.until).toLocaleDateString() : '';
          document.getElementById('meta-line').textContent = `Window: ${startText}${endText ? ' → ' + endText : ''} · Successes: ${meta.successes ?? s.successes ?? '--'} · Failures: ${meta.failures ?? s.failures ?? '--'} · Commits: ${meta.commits ?? '--'}`;
        } else {
          const daysVal = param && typeof param === 'number' ? param : (meta.window_days || s.window_days || 60);
          document.getElementById('meta-line').textContent = `Window: ${daysVal} days · Successes: ${meta.successes ?? s.successes ?? '--'} · Failures: ${meta.failures ?? s.failures ?? '--'} · Commits: ${meta.commits ?? '--'}`;
        }

        document.getElementById('total-deploy').textContent = s.total_deployments ?? (meta.successes + meta.failures) ?? '--';
        document.getElementById('avg-lead').textContent = s.median_lead_hours !== undefined ? (s.median_lead_hours !== null ? `${s.median_lead_hours} hr` : 'N/A') : (meta.avg_lead_time_hours ? `${meta.avg_lead_time_hours} hr` : 'N/A');
        document.getElementById('med-lead').textContent = s.median_lead_hours !== null ? `${s.median_lead_hours} hr` : 'N/A';
        document.getElementById('p95-lead').textContent = s.p95_lead_hours !== null ? `${s.p95_lead_hours} hr` : 'N/A';
        document.getElementById('contributors').textContent = s.contributors_count ?? '--';

        const daysKeys = Object.keys(daily).sort();
        const freq = daysKeys.map(d => daily[d].deployment_frequency ?? 0);
        const cfr = daysKeys.map(d => daily[d].change_failure_rate == null ? null : +daily[d].change_failure_rate.toFixed(2));
        const lead = daysKeys.map(d => daily[d].lead_time_ms_mean != null ? +(daily[d].lead_time_ms_mean / 3600000).toFixed(3) : null);

        drawChartFrequency(daysKeys, freq);
        drawChartCFR(daysKeys, cfr);
        drawChartLead(daysKeys, lead);

        renderRunsTable(runsResp.runs || [], document.getElementById('tz').value);
        document.getElementById('exportCsv').onclick = () => exportCsv(daily);

      } catch (err) {
        console.error('Dashboard load error', err);
        showBanner('Failed to load dashboard. If you opened this file directly, run `npm start` and open http://localhost:3000/dashboard.html. Error: ' + (err.message || err));
      }
    }

    // UI wiring
    flatpickr('#daterange', {
      mode: 'range',
      enableTime: false,
      dateFormat: 'Y-m-d',
      defaultDate: null,
      onChange: function(selectedDates, dateStr, instance) {
        if (!selectedDates || selectedDates.length === 0) return;
        if (selectedDates.length === 1) {
          // single date selected -> treat as a single-day window
          const since = selectedDates[0].toISOString();
          loadDashboard({ since });
        } else if (selectedDates.length >= 2) {
          const since = selectedDates[0].toISOString();
          // Use end of day for until for inclusive behavior
          const untilDate = selectedDates[1];
          untilDate.setHours(23,59,59,999);
          const until = untilDate.toISOString();
          loadDashboard({ since, until });
        }
      }
    });
    document.getElementById('daterange').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const v = e.target.value.trim();
        const n = Number(v);
        if (!isNaN(n) && n > 0) { loadDashboard(n); } else {
          const d = new Date(v);
          if (!isNaN(d)) {
            const diff = Math.ceil((Date.now() - d.getTime()) / (1000*60*60*24));
            loadDashboard(diff);
          } else { alert('Enter a valid number of days or a valid date.'); }
        }
      }
    });

    document.getElementById('refresh').addEventListener('click', () => {
      // Refresh using the currently selected range (days number or since/until object)
      loadDashboard(currentRange ?? null);
    });

    document.getElementById('tz').addEventListener('change', () => loadDashboard());

    loadDashboard();
  </script>
</body>
</html>